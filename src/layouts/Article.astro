---
// FILE: src/layouts/Article.astro
import Layout from "./Layout.astro"
import Sidebar from "../components/Sidebar.astro"
import FormattedDate from "../components/FormattedDate.astro"
import ShareButtons from "../components/ShareButtons.astro"
import { getCollection } from "astro:content"
import { Image } from "astro:assets"

interface ArticleProps {
  title?: string
  author?: string  // username author
  pubdate?: Date | null
  heroImage?: string | null
  description?: string
  body?: string
  url?: string
  image?: string
  category?: string
}

const props = Astro.props as ArticleProps
const { 
  title, 
  author: authorUsername, 
  pubdate, 
  heroImage, 
  description, 
  url,  
  category 
} = props

// Normalize date
const pubdateDate = pubdate ? new Date(pubdate) : null

// Normalize image
const heroSrc = typeof heroImage === 'string' ? heroImage : undefined

// Get author data
let authorData = null;
if (authorUsername) {
  try {
    const authors = await getCollection("authors");
    const author = authors.find(a => a.data.username === authorUsername);
    authorData = author?.data ?? null;
  } catch (error) {
  }
}

---

<Layout 
  title={title} 
  description={description}
>
  <section class="py-12">
    <div class="container px-6 mx-auto w-full h-full overflow-hidden flex flex-col lg:flex-row gap-6">
      <div class="w-full lg:w-3/4 space-y-3 px-2">
        <h1 class="text-2xl md:text-3xl lg:text-3xl font-bold text-primary">{title}</h1>

        <div class="flex flex-wrap items-center gap-4 mb-4">
          {authorData && (
            <a 
              href={`/author/${authorData.username}`}
              class="flex items-center gap-1 group hover:opacity-80 transition"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="text-muted " width="18" height="18" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></g></svg>
              <div>
                <p class="font-medium text-muted group-hover:text-primary">
                  {authorData.name}
                </p>
              </div>
            </a>
          )}
          
          {/* FALLBACK */}
          {!authorData && authorUsername && (
            <div class="flex items-center gap-2 text-muted">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1">
                  <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </g>
              </svg>
              <span>{authorUsername}</span>
            </div>
          )}

          <div class="flex items-center gap-2 text-muted">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
              <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="m15 16l-2.414-2.414A2 2 0 0 1 12 12.172V6"></path>
              </g>
            </svg>
            <FormattedDate date={pubdateDate} />
          </div>
          
          {category && (
            <span class="bg-surface text-primary text-sm px-3 py-1 rounded-full">
              {category}
            </span>
          )}
        </div>

        {heroSrc && (
          <div class="relative w-full aspect-video overflow-hidden rounded-lg mb-6">
            
            <Image
              src={heroSrc}
              alt={title ?? ""}
              width="1200" height="675"
              class="w-full h-full object-cover object-center"
            />
          </div>
        )}

        <article class="prose prose-headings:text-primary prose-p:text-justify max-w-none">
          <slot />
        </article>


        <div class="mt-8">
          <ShareButtons url={url} title={title ?? ""} />
        </div>
      </div>

      <Sidebar />
    </div>
  </section>
</Layout>