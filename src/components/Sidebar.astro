---
import { getCollection } from "astro:content";
import LatestPosts from "./LatestPosts.astro";




const allPosts = await getCollection("posts");

// Proses posts untuk mendapatkan category dan slug yang benar
const processedPosts = allPosts.map((post) => {
  const filePath = post.filePath ?? "";
  let category = "";
  let slug = "";

  // Extract category dari filePath
  if (filePath.startsWith("src/content/posts/")) {
    const relPath = filePath.replace(/^src\/content\/posts\//, "");
    const parts = relPath.split("/");
    if (parts.length >= 2) {
      category = parts[0];
      // Slug adalah sisa path tanpa extension
      slug = parts
        .slice(1)
        .join("/")
        .replace(/\.mdx?$/, "");
    }
  }

  // Fallback ke frontmatter jika tidak ditemukan di filePath
  if (!category && post.data.category) {
    category = post.data.category;
  }

  // Fallback untuk slug - gunakan id sebagai fallback
  if (!slug) {
    slug = post.id.split("/").pop() ?? "";
  }

  return {
    slug,
    category,
    data: post.data,
  };
});

// Filter posts by category (contoh: pengumuman)
const pengumumanPosts = processedPosts
  .filter((post) => post.category.toLowerCase() === "pengumuman")
  .sort((a, b) => {
    // Gunakan pubdate, jika tidak ada gunakan tanggal default
    const dateA = new Date(a.data.pubdate ?? 0).getTime();
    const dateB = new Date(b.data.pubdate ?? 0).getTime();
    return dateB - dateA; // Terbaru dulu
  });

// Atau ambil semua posts terbaru
const latestPosts = processedPosts
  .sort((a, b) => {
    const dateA = new Date(a.data.pubdate ?? 0).getTime();
    const dateB = new Date(b.data.pubdate ?? 0).getTime();
    return dateB - dateA;
  })
  .slice(0, 6); // 6 post terbaru
---

<div class="w-full lg:w-1/4 ps-4 lg:border-l border-border">
    <div class="">
        <div class="flex items-center gap-2 mb-3">
            <h2 class=" text-primary flex-none uppercase">Recent Post</h2>
            <span class="inline-block grow  w-full h-px bg-primary/50"></span>
        </div>
        <LatestPosts 
        posts={latestPosts} 
        maxPosts={5} 
        layout="sidebar" 
        showDescription={false} 
        />
        <hr class="h-px my-8 bg-surface border-0" />
        <div class="flex items-center gap-2 mb-3">
            <h2 class=" text-primary flex-none uppercase">Pengumuman</h2>
            <span class="inline-block grow  w-full h-px bg-primary/50"></span>
        </div>
        <LatestPosts 
        posts={pengumumanPosts} 
        maxPosts={5} 
        layout="sidebar" 
        showDescription={false} 
        />
        
    </div>
</div>
