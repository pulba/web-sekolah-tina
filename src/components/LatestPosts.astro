---
// file: components/LatestPosts.astro
import FormattedDate from "./FormattedDate.astro";
import { getCollection } from "astro:content";

interface PostData {
  title: string
  author?: string  // username author
  pubdate?: Date | string
  heroImage?: string
  description?: string
  category?: string
}

interface AuthorData {
  username: string
  name: string
  avatar?: string
  bio?: string
}

interface Post {
  slug: string
  category: string
  data: PostData
}

interface Props {
  posts: Post[]
  maxPosts?: number
  layout?: 'grid' | 'sidebar'
  showDescription?: boolean
  showAuthorBio?: boolean  // Opsi tambahan untuk tampilan author lengkap
}

const { 
  posts, 
  maxPosts = 6, 
  layout = 'grid', 
  showDescription = true,
  showAuthorBio = false  // Default false untuk komponen list
} = Astro.props

const displayedPosts = posts.slice(0, maxPosts)

// Fungsi untuk mengambil data author dari koleksi
async function getAuthorData(username: string): Promise<AuthorData | null> {
  if (!username) return null;
  
  try {
    const authors = await getCollection("authors");
    const author = authors.find(a => a.data.username === username);
    return author?.data ?? null;
  } catch (error) {
    return null;
  }
}

// Pre-fetch semua data author sekaligus untuk performa lebih baik
const authorPromises = displayedPosts
  .filter(post => post.data.author)
  .map(async (post) => {
    const authorData = await getAuthorData(post.data.author!);
    return { username: post.data.author!, data: authorData };
  });

const authorResults = await Promise.all(authorPromises);
const authorMap = new Map(
  authorResults.map(result => [result.username, result.data])
);

function excerpt(text: string | undefined, limit: number): string {
  if (!text) return "";
  return text.length > limit ? text.slice(0, limit) + "..." : text;
}

function isTextTruncated(text: string | undefined, limit: number): boolean {
  if (!text) return false;
  return text.length > limit;
}
---

{layout === 'grid' ? (
  <!-- Layout Grid (Default untuk Home) -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    {displayedPosts.map((post) => {
      const img = post.data?.heroImage ?? "/uploads/default-thumb.jpg"
      const pub = post.data?.pubdate ?? null
      const dateObj = pub ? new Date(pub) : null
      const rawCategory = post.category || post.data.category || "uncategorized"
      const categorySlug = rawCategory.toLowerCase() || "uncategorized"
      const categoryLabel =
        categorySlug === "uncategorized"
          ? "Uncategorized"
          : categorySlug.charAt(0).toUpperCase() + categorySlug.slice(1)

      const slug = (post.slug || "").toString()
      
      // Ambil data author dari map
      const authorUsername = post.data.author
      const authorData = authorUsername ? authorMap.get(authorUsername) : null

      return (
        <div class="bg-surface rounded-md shadow-md overflow-hidden hover:shadow-lg transition-shadow" data-animate="fade">
          <div class="relative overflow-hidden">
            <a href={`/posts/${categorySlug}/${slug}`}>
              <img
                src={img}
                alt={post.data.title}
                loading="lazy"
                width="300"
                height="180"
                class="w-full h-48 object-cover hover:scale-125 hover:-skew-3 transition-transform duration-300"
              />
            </a>
            {dateObj && (
              <div class="absolute bottom-0 left-0 rounded-tr-md bg-primary text-surface px-3 py-1 text-sm font-semibold">
                <FormattedDate date={dateObj} />
              </div>
            )}
          <span class="absolute top-0 right-0">
                <a href={`/posts/${post.category}/`}>
                  <p class="bg-surface text-primary text-xs px-2 py-1 rounded-tr-md capitalize">{post.category}</p>
                </a>
              </span>
          </div>
          <div class="p-4">
            <div class="font-bold text-lg mb-2 leading-6">
              <a 
                href={`/posts/${categorySlug}/${slug}`}
                class="transition-colors"
              >
                <h3 class="text-heading hover:text-secondary">{post.data.title}</h3>
              </a>
            </div>
            
            {showDescription && post.data.description && (
              <div class="mb-3">
                <p class="text-muted text-sm inline">
                  {excerpt(post.data.description, 100)}
                  {/* Link inline setelah titik-titik  */}
                  {isTextTruncated(post.data.description, 100) && (
                    <a 
                      href={`/posts/${categorySlug}/${slug}`}
                      class="inline-flex items-center font-medium ml-1 whitespace-nowrap"
                    >
                      Read more
                      <svg class="w-3 h-3 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  )}
                </p>
              </div>
            )}
            {/* AUTHOR SECTION - Enhanced */}
            {authorUsername && (
              <div class="flex items-center mb-3">
                {authorData ? (
                  <a 
                    href={`/author/${authorData.username}`}
                    class="flex items-center gap-2 group hover:opacity-80 transition"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="text-muted" width="16" height="16" viewBox="0 0 24 24">
                          <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                          </g>
                        </svg>
                    <span class="text-sm font-medium text-muted group-hover:text-secondary">
                      {authorData.name}
                    </span>
                  </a>
                ) : (
                  <!-- Mode Fallback -->
                  <div class="flex items-center text-muted">
                    <div class="w-8 h-8 rounded-full bg-surface flex items-center justify-center">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </g>
                      </svg>
                    </div>
                    <span class="text-sm">{authorUsername}</span>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      )
    })}

  </div>
) : (
  <!-- Layout Sidebar (Horizontal) -->
  <div class="space-y-4">
    {displayedPosts.map((post) => {
      const img = post.data?.heroImage ?? "/uploads/default-thumb.jpg"
      const pub = post.data?.pubdate ?? null
      const dateObj = pub ? new Date(pub) : null
      const rawCategory = post.category || post.data.category || "uncategorized"
      const categorySlug = rawCategory.toLowerCase() || "uncategorized"
      const categoryLabel =
        categorySlug === "uncategorized"
          ? "Uncategorized"
          : categorySlug.charAt(0).toUpperCase() + categorySlug.slice(1)

      const slug = (post.slug || "").toString()
      
      // Ambil data author dari map
      const authorUsername = post.data.author
      const authorData = authorUsername ? authorMap.get(authorUsername) : null

      return (
        <article class="bg-surface border border-border rounded-lg p-3 hover:shadow-md transition-shadow flex gap-3 relative" data-animate="fade">
          <!-- Gambar -->
          <div class="shrink-0 w-20 h-20 overflow-hidden rounded">
            <a href={`/posts/${categorySlug}/${slug}`}>
              <img
                src={img}
                alt={post.data.title}
                loading="lazy"
                class="w-full h-full object-cover rounded hover:scale-125 hover:-skew-3 transition-transform duration-300"
              />
            </a>
          </div>
          
          <!-- Konten -->
          <div class="flex-1 min-w-0">
            {dateObj && (
              <div class="text-primary text-xs font-semibold mb-1">
                <FormattedDate date={dateObj} />
              </div>
            )}
            
            <div class="font-bold text-sm text-green-800 line-clamp-2 mb-1">
              <a 
                href={`/posts/${categorySlug}/${slug}`}
                class="transition-colors"
              > 
              <h3 class="text-heading hover:text-secondary">{post.data.title}</h3>
              </a>
            </div>
            
            {/* Conditional Description untuk Sidebar Layout */}
            {showDescription && post.data.description && (
              <p class="text-muted text-xs line-clamp-2 mb-1">
                {excerpt(post.data.description, 60)}
              </p>
            )}
            
            {/* AUTHOR SECTION - Compact untuk Sidebar */}
            {authorUsername && (
              <div class="flex items-center text-xs mb-1 group">
                {authorData ? (
                  <a 
                    href={`/author/${authorData.username}`}
                    class="flex items-center gap-1 transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="text-muted" width="14" height="14" viewBox="0 0 24 24">
                          <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                          </g>
                        </svg>
                    <span class="font-medium text-muted group-hover:text-secondary">{authorData.name}</span>
                  </a>
                ) : (
                  <div class="flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" class="mr-1">
                      <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                      </g>
                    </svg>
                    {authorUsername}
                  </div>
                )}
              </div>
            )}
            
            <div class="absolute top-0 right-0 inline-block text-[10px]">
              <a href={`/posts/${post.category}/`} class="">
                <p class="bg-primary text-surface px-2 py-1 rounded-bl-sm rounded-tr-sm capitalize">{post.category}</p>
              </a>
            </div>
          </div>
        </article>
      )
    })}
  </div>
)}

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>

