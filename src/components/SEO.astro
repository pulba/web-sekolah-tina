---
// src/components/SEO.astro
import { getCollection } from 'astro:content';

interface SEOProps {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  noindex?: boolean;
  canonical?: string;
}

const { 
  title = '',
  description = '',
  image = '',
  url = '',
  type = 'website',
  publishedTime,
  modifiedTime,
  tags = [],
  noindex = false,
  canonical = ''
} = Astro.props;

const parseStructuredData = (dataString: string | undefined) => {
  if (!dataString) return null;
  try {
    return JSON.parse(dataString);
  } catch {
    return null;
  }
};

// Ambil data SEO dari TinaCMS
let settingsData = null;

try {
  const settingsCollection = await getCollection("settings");
  settingsData = settingsCollection[0]?.data ?? null;
} catch (error) {
  settingsData = null;
}

const seoData = settingsData?.seo || {};

const siteInfo = seoData?.siteInfo || {
  siteName: "SMA N 1 Indonesia",
  siteUrl: "https://masmifhda.sch.id",
  siteDescription: "",
  siteLogo: "",
  favicon: "/favicon.ico",
};

const globalMeta = seoData?.globalMeta || {
  titleTemplate: "%s | SMA N 1 Indonesia",
  defaultTitle: "SMA N 1 Indonesia - Sekolah Unggulan",
  defaultDescription:
    "SMA Negeri 1 Indonesia - Sekolah unggulan dengan pendidikan berbasis karakter dan prestasi",
  defaultKeywords:
    "sekolah islam, madrasah, pendidikan, SMA Negeri 1 Indonesia, sekolah unggulan",
  author: "SMA N 1 Indonesia",
};

const openGraph = seoData?.openGraph || {
  type: "website",
  locale: "id_ID",
  image: "",
  fbAppId: "",
};

const twitter = seoData?.twitter || {
  card: "summary_large_image",
  site: "",
  creator: "",
};

const analytics = seoData?.analytics || {
  gaId: "",
  gtmId: "",
  googleSiteVerification: "",
  bingSiteVerification: "",
  yandexVerification: "",
};

// Generate meta tags
const pageTitle = title 
  ? globalMeta.titleTemplate.replace('%s', title)
  : globalMeta.defaultTitle;

const pageDescription = description || globalMeta.defaultDescription;
const pageImage = image || openGraph.image || siteInfo.siteLogo;
const fullUrl = url 
  ? `${siteInfo.siteUrl}${url.startsWith('/') ? url : '/' + url}`
  : siteInfo.siteUrl;
const pageType = type;

// Generate canonical URL
const canonicalUrl = canonical 
  ? `${siteInfo.siteUrl}${canonical.startsWith('/') ? canonical : '/' + canonical}`
  : fullUrl;

// Robots meta
const robotsContent = noindex ? 'noindex, nofollow' : 'index, follow';

// Helper untuk URL gambar lengkap
const getFullImageUrl = (imgPath: string) => {
  if (!imgPath) return '';
  if (imgPath.startsWith('http')) return imgPath;
  return `${siteInfo.siteUrl}${imgPath.startsWith('/') ? imgPath : '/' + imgPath}`;
};

const orgStructuredData = parseStructuredData(seoData?.structuredData?.organization);
const websiteStructuredData = parseStructuredData(seoData?.structuredData?.website);
---

<!-- Favicon -->
<link rel="icon" href={siteInfo.favicon} type="image/x-icon" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css"/>

<!-- Basic Meta Tags -->
<title>{pageTitle}</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<meta name="description" content={pageDescription} />
{globalMeta.defaultKeywords && <meta name="keywords" content={globalMeta.defaultKeywords} />}
{globalMeta.author && <meta name="author" content={globalMeta.author} />}
{noindex && <meta name="robots" content={robotsContent} />}

<!-- Canonical URL -->
<link rel="canonical" href={canonicalUrl} />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:type" content={pageType} />
<meta property="og:url" content={fullUrl} />
<meta property="og:site_name" content={siteInfo.siteName} />
{openGraph.locale && <meta property="og:locale" content={openGraph.locale} />}

{pageImage && (
  <>
    <meta property="og:image" content={getFullImageUrl(pageImage)} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={pageTitle} />
  </>
)}

{openGraph.fbAppId && (
  <meta property="fb:app_id" content={openGraph.fbAppId} />
)}

{publishedTime && (
  <meta property="article:published_time" content={publishedTime} />
)}

{modifiedTime && (
  <meta property="article:modified_time" content={modifiedTime} />
)}

{tags.length > 0 && tags.map((tag: string) => (
  <meta property="article:tag" content={tag} />
))}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content={twitter.card} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />

{twitter.site && (
  <meta name="twitter:site" content={twitter.site} />
)}

{twitter.creator && (
  <meta name="twitter:creator" content={twitter.creator} />
)}

{pageImage && (
  <>
    <meta name="twitter:image" content={getFullImageUrl(pageImage)} />
    <meta name="twitter:image:alt" content={pageTitle} />
  </>
)}

<!-- Site Verification -->
{analytics.googleSiteVerification && (
  <meta name="google-site-verification" content={analytics.googleSiteVerification} />
)}

{analytics.bingSiteVerification && (
  <meta name="msvalidate.01" content={analytics.bingSiteVerification} />
)}

{analytics.yandexVerification && (
  <meta name="yandex-verification" content={analytics.yandexVerification} />
)}

<!-- Google Analytics -->
{analytics.gaId && (
  <>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${analytics.gaId}`} />
    <script>
      {`
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '${analytics.gaId}');
      `}
    </script>
  </>
)}

<!-- Google Tag Manager -->
{analytics.gtmId && (
  <>
    <script>
      {`(function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        if(f.parentNode) f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','${analytics.gtmId}');`}
    </script>
  </>
)}

<!-- Structured Data -->
{orgStructuredData && (
  <script type="application/ld+json">
    {JSON.stringify(orgStructuredData)}
  </script>
)}

{websiteStructuredData && (
  <script type="application/ld+json">
    {JSON.stringify(websiteStructuredData)}
  </script>
)}

<!-- Page-specific structured data -->
<script type="application/ld+json">
{JSON.stringify({
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": pageTitle,
  "description": pageDescription,
  "url": fullUrl,
  "publisher": {
    "@type": "EducationalOrganization",
    "name": siteInfo.siteName,
    "url": siteInfo.siteUrl
  }
})}
</script>

<!-- GTM noscript -->
{analytics.gtmId && (
  <noscript>
    <iframe 
      src={`https://www.googletagmanager.com/ns.html?id=${analytics.gtmId}`} 
      height="0" 
      width="0" 
      style="display:none;visibility:hidden"
    />
  </noscript>
)}