---
// file: src/components/Highlight.astro
import type { CollectionEntry } from 'astro:content';
import { getEntry, getCollection } from 'astro:content';
import LatestPosts from './LatestPosts.astro';

interface PostData {
  title: string
  author?: string
  pubdate?: Date | string
  heroImage?: string
  description?: string
  category?: string
}

interface Post {
  slug: string
  category: string
  data: PostData
}

function getSafeImageSrc(path: string | undefined): string {
  if (!path) return '/uploads/default-thumb.jpg';
  return path.startsWith('/') ? path : `/${path}`;
}

// 1. Ambil data PPDB settings - PERHATIAN: di export sebagai 'ppdb'
  const ppdbData = await getCollection('ppdb').catch(() => []);
  const ppdbSettings = ppdbData.find(item => item.id === 'settings') || ppdbData[0];


  // 2. Ambil semua pamflate
  const allPamflate = await getCollection('pamflate').catch(() => []);


  // 3. Proses highlight pamflet
  let pamfletToDisplay = {
    image: '/uploads/default-pamflet.jpg',
    title: 'Pamflet PPDB',
    description: '',
    link: '#',
    show: true
  };

  // Cek apakah ada settings dan highlight pamflet aktif
  // Perhatikan struktur data: ppdbSettings.data.highlightPamflet
  const highlightEnabled = ppdbSettings?.data?.highlightPamflet?.enabled !== false;
  const hasHighlightData = ppdbSettings?.data?.highlightPamflet;


  if (highlightEnabled && hasHighlightData) {
    const highlight = ppdbSettings.data.highlightPamflet;
    
    // OPTION 1: Jika menggunakan reference ke koleksi pamflate
    if (highlight.pamflet) {
      
      // Format ID di Astro biasanya: "pamflate/filename"
      const pamfletId = highlight.pamflet.startsWith('pamflate/') 
        ? highlight.pamflet 
        : `pamflate/${highlight.pamflet}`;
      
      // Cari berdasarkan ID atau slug
      const selectedPamflet = allPamflate.find(p => {
        return p.id === pamfletId || 
              p.slug === highlight.pamflet ||
              p.id.endsWith(`/${highlight.pamflet}`);
      });
      
      if (selectedPamflet) {
        pamfletToDisplay.image = getSafeImageSrc(selectedPamflet.data.heroImage);
        pamfletToDisplay.title = selectedPamflet.data.title;
        pamfletToDisplay.description = selectedPamflet.data.description || '';
        pamfletToDisplay.link = `/pamflate/${selectedPamflet.slug}`;
        pamfletToDisplay.show = true;
      } else {
        // Fallback ke custom
        if (highlight.customImage) {
          pamfletToDisplay.image = getSafeImageSrc(highlight.customImage);
          pamfletToDisplay.title = highlight.customTitle || 'Pamflet PPDB';
          pamfletToDisplay.description = highlight.customDescription || '';
          pamfletToDisplay.link = highlight.customLink || '#';
          pamfletToDisplay.show = true;
        }
      }
    } 
    // OPTION 2: Jika menggunakan custom image langsung
    else if (highlight.customImage) {
      pamfletToDisplay.image = getSafeImageSrc(highlight.customImage);
      pamfletToDisplay.title = highlight.customTitle || 'Pamflet PPDB';
      pamfletToDisplay.description = highlight.customDescription || '';
      pamfletToDisplay.link = highlight.customLink || '#';
      pamfletToDisplay.show = true;
    }
  }

  // 4. Fallback: Jika belum dapat pamflet, cari yang terbaru dengan kategori PPDB
  if (!pamfletToDisplay.show || pamfletToDisplay.image === '/uploads/default-pamflet.jpg') {
    
    const ppdbPamflets = allPamflate
      .filter(p => {
        // Cek kategori PPDB
        const isPpdbCategory = p.data.category === 'ppdb';
        // Cek aktif
        const isActive = p.data.active !== false;
        // Cek punya gambar
        const hasImage = !!p.data.heroImage;
        
        return isPpdbCategory && isActive && hasImage;
      })
      .sort((a, b) => {
        const dateA = new Date(a.data.pubDate || 0).getTime();
        const dateB = new Date(b.data.pubDate || 0).getTime();
        return dateB - dateA; // Terbaru dulu
      });
    
    
    if (ppdbPamflets.length > 0) {
      const latestPamflet = ppdbPamflets[0];
      pamfletToDisplay.image = getSafeImageSrc(latestPamflet.data.heroImage);
      pamfletToDisplay.title = latestPamflet.data.title;
      pamfletToDisplay.description = latestPamflet.data.description || '';
      pamfletToDisplay.link = `/pamflate/${latestPamflet.slug}`;
      pamfletToDisplay.show = true;
    }
  }

// Ambil data profile (sambutan kepala sekolah)
const about = await getEntry("about", "index");
const sambutanKepsek = about?.data?.sambutan?.items?.[0] || null;

const sambutanTitle = sambutanKepsek?.title || "Sambutan Kepala Sekolah";
const sambutanImage = sambutanKepsek?.image
  ? getSafeImageSrc(sambutanKepsek.image)
  : "/uploads/default-thumb.jpg";

const styledExcerpt = sambutanKepsek
  ? getStyledExcerpt(sambutanKepsek.body, 200)
  : { __html: "Sambutan kepala sekolah akan segera tersedia..." };
function getStyledExcerpt(body: string | undefined, limit: number) {
  if (!body) return { __html: "Sambutan kepala sekolah akan segera tersedia..." };
  
  let cleanText = body
    .replace(/^#+\s+/gm, '')
    .replace(/\*\*/g, '')
    .replace(/\*/g, '')
    .replace(/<[^>]*>/g, '')
    .trim();

  const paragraphs = cleanText.split(/\n\s*\n/).filter(p => p.trim().length > 0);
  
  let result = '';
  let totalLength = 0;
  
  for (let i = 0; i < paragraphs.length; i++) {
    const paragraph = paragraphs[i].trim();
    const lines = paragraph.split('\n').filter(line => line.trim().length > 0);
    
    for (let j = 0; j < lines.length; j++) {
      const line = lines[j].trim();
      
      if (totalLength + line.length > limit && i > 0) {
        const remaining = limit - totalLength;
        if (remaining > 10) {
          result += `<span class="text-gray-700 block">${line.slice(0, remaining)}...</span>`;
        }
        return { __html: result };
      }
      
      if (line.toLowerCase().includes('bismillah')) {
        result += `<span class="font-bold text-md md:text-lg italic text-primary block mb-2">${line}</span>`;
      } else if (line.toLowerCase().includes('assalamu')) {
        result += `<span class="font-bold italic text-sm text-primary block mb-3">${line}</span>`;
      } else {
        result += `<span class="text-muted block">${line}</span>`;
      }
      
      totalLength += line.length;
    }
    
    if (i < paragraphs.length - 1) {
      result += '<div class="mb-2"></div>';
    }
  }
  
  return { __html: result };
}

// Ambil data pengumuman
const allPosts = await getCollection("posts").catch(() => []);

// Proses posts untuk mendapatkan category dan slug yang benar
const processedPosts = allPosts.map((post) => {
  const filePath = post.filePath ?? "";
  let category = "";
  let slug = "";

  // Extract category dari filePath
  if (filePath.startsWith("src/content/posts/")) {
    const relPath = filePath.replace(/^src\/content\/posts\//, "");
    const parts = relPath.split("/");
    if (parts.length >= 2) {
      category = parts[0];
      slug = parts
        .slice(1)
        .join("/")
        .replace(/\.mdx?$/, "");
    }
  }

  if (!category && post.data.category) {
    category = post.data.category;
  }

  if (!slug) {
    slug = post.id.split("/").pop() ?? "";
  }

  return {
    slug,
    category,
    data: post.data,
  };
});

// Filter posts by category
const pengumumanPosts = processedPosts
  .filter((post) => post.category.toLowerCase() === "pengumuman")
  .sort((a, b) => {
    const dateA = new Date(a.data.pubdate ?? 0).getTime();
    const dateB = new Date(b.data.pubdate ?? 0).getTime();
    return dateB - dateA;
  });

// Fungsi untuk mendapatkan excerpt dengan styling


---

<section>
  <div class="container mx-auto px-4 py-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Kolom 1: Pamflet -->
    {pamfletToDisplay.show && (
      <div data-animate="fade" class="bg-white shadow rounded-md overflow-hidden order-last lg:order-0">
        <img
            src={pamfletToDisplay.image}
            alt={pamfletToDisplay.title}
            loading="lazy"
            decoding="async"
            class="rounded-md aspect-4/5 object-cover object-top w-full"
            onerror="this.onerror=null;this.src='/uploads/default-thumb.jpg';"
          />
      </div>
    )}

    <!-- Kolom 2: Pengumuman -->
    <LatestPosts 
        posts={pengumumanPosts} 
        maxPosts={3} 
        layout="sidebar" 
        showDescription={true} 
        />

    <!-- Kolom 3: Sambutan Kepala Sekolah -->
    <div data-animate="fade" class="p-4 shadow rounded-md order-first lg:order-0">
    <h2 class="text-xl font-bold mb-3 text-primary">
      {sambutanTitle}
    </h2>

    <div class="relative overflow-hidden rounded-md mb-3">
      <img
        src={sambutanImage}
        alt="Kepala Sekolah"
        loading="lazy"
        class="rounded-md aspect-video object-cover object-center w-full"
        onerror="this.onerror=null;this.src='/uploads/default-thumb.jpg';"
      />
    </div>

    <div class="text-sm space-y-2">
      <div set:html={styledExcerpt.__html} />
      {sambutanKepsek && (
        <a
          href="/about/sambutan"
          class="inline-block float-end font-semibold hover:underline mt-2"
        >
          Selengkapnya â†’
        </a>
      )}
    </div>
  </div>

  </div>
</section>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>